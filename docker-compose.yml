services:
  agent:
    # ローカルでビルドする場合
    build:
      context: .
      dockerfile: Dockerfile
    # DockerHubからpullする場合は、以下の行のコメントを外して、build: をコメントアウト
    # image: your-username/cursor-scage:latest
    volumes:
      # エージェントシステム自体のコードをマウント
      - .:/workspace
      # 作業対象のプロジェクトディレクトリをマウント
      # TARGET_PROJECT環境変数で指定（未指定の場合は現在のディレクトリ）
      - ${TARGET_PROJECT:-.}:/target
      # 状態ファイルを永続化（STATE_DIR / LOG_DIR で指定したパスをマウント）
      - ./${STATE_DIR:-state}:/workspace/${STATE_DIR:-state}
      - ./${LOG_DIR:-logs}:/workspace/${LOG_DIR:-logs}
      # Cursor CLIの認証情報を永続化（重要）
      # 認証情報は /root/.cursor と /root/.config/cursor の両方に保存される
      - cursor-config:/root/.cursor
      - cursor-config-config:/root/.config/cursor
    environment:
      # 作業対象プロジェクトのルート（TARGET_PROJECTが設定されている場合は/target、未設定の場合は/workspace）
      - PROJECT_ROOT=${PROJECT_ROOT:-/target}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PROJECT_GOAL=${PROJECT_GOAL:-プロジェクトの目標を設定してください}
      # ダッシュボードモード（true/1/onで有効化）
      - DASHBOARD=${DASHBOARD:-false}
      # .envファイルから環境変数を読み込む
      - LLM_BACKEND=${LLM_BACKEND:-cursor_cli}
      - LLM_OUTPUT_FORMAT=${LLM_OUTPUT_FORMAT:-text}
      - LLM_MODEL=${LLM_MODEL:-}
      # Agent-specific model configuration
      - PLANNER_MODEL=${PLANNER_MODEL:-}
      - WORKER_MODEL=${WORKER_MODEL:-}
      - JUDGE_MODEL=${JUDGE_MODEL:-}
      # Dynamic model selection for workers
      - WORKER_MODEL_LIGHT=${WORKER_MODEL_LIGHT:-}
      - WORKER_MODEL_STANDARD=${WORKER_MODEL_STANDARD:-}
      - WORKER_MODEL_POWERFUL=${WORKER_MODEL_POWERFUL:-}
      # Model selection configuration
      - MODEL_SELECTION_ENABLED=${MODEL_SELECTION_ENABLED:-false}
      - MODEL_COMPLEXITY_THRESHOLD_LIGHT=${MODEL_COMPLEXITY_THRESHOLD_LIGHT:-10.0}
      - MODEL_COMPLEXITY_THRESHOLD_POWERFUL=${MODEL_COMPLEXITY_THRESHOLD_POWERFUL:-30.0}
      - STATE_DIR=${STATE_DIR:-state}
      - LOG_DIR=${LOG_DIR:-logs}
      - WAIT_TIME_SECONDS=${WAIT_TIME_SECONDS:-60}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-100}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - MAX_PARALLEL_WORKERS=${MAX_PARALLEL_WORKERS:-3}
      - ENABLE_PARALLEL_EXECUTION=${ENABLE_PARALLEL_EXECUTION:-true}
      # Git configuration used by agents inside the container
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
    working_dir: /workspace
    # ネットワークアクセスを許可（API呼び出し用）
    network_mode: bridge
    # 長時間実行を許可
    restart: unless-stopped
    # インタラクティブモードで実行（初回認証用）
    stdin_open: true
    tty: true

volumes:
  cursor-config:
    # Cursor CLIの認証情報を永続化（/root/.cursor）
  cursor-config-config:
    # Cursor CLIの認証情報を永続化（/root/.config/cursor）
