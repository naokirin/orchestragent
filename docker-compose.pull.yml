# DockerHubからイメージをpullして実行する場合の設定
# 使用方法: docker compose -f docker-compose.pull.yml up
#
# イメージを公開する場合:
# docker build -t your-username/cursor-scage:latest .
# docker push your-username/cursor-scage:latest

services:
  agent:
    # DockerHubからイメージをpull（build: の代わりにimage: を指定）
    image: your-username/cursor-scage:latest
    # ローカルのコードをマウントしない（イメージ内のコードを使用）
    # volumes:
    #   - .:/workspace  # この行をコメントアウト
    volumes:
      # 作業対象のプロジェクトディレクトリをマウント
      # TARGET_PROJECT環境変数で指定（未指定の場合は現在のディレクトリ）
      - ${TARGET_PROJECT:-.}:/target
      # 状態ファイルを永続化（ホスト側に保存）
      - ./state:/workspace/state
      - ./logs:/workspace/logs
      # Cursor CLIの認証情報を永続化（重要）
      # 認証情報は /root/.cursor と /root/.config/cursor の両方に保存される
      - cursor-config:/root/.cursor
      - cursor-config-config:/root/.config/cursor
    environment:
      # 作業対象プロジェクトのルート（TARGET_PROJECTが設定されている場合は/target、未設定の場合は/workspace）
      - PROJECT_ROOT=${PROJECT_ROOT:-/target}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PROJECT_GOAL=${PROJECT_GOAL:-プロジェクトの目標を設定してください}
      # .envファイルから環境変数を読み込む
      - LLM_BACKEND=${LLM_BACKEND:-cursor_cli}
      - LLM_OUTPUT_FORMAT=${LLM_OUTPUT_FORMAT:-text}
      - LLM_MODEL=${LLM_MODEL:-}
      - STATE_DIR=${STATE_DIR:-state}
      - LOG_DIR=${LOG_DIR:-logs}
      - WAIT_TIME_SECONDS=${WAIT_TIME_SECONDS:-60}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-100}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - MAX_PARALLEL_WORKERS=${MAX_PARALLEL_WORKERS:-3}
      - ENABLE_PARALLEL_EXECUTION=${ENABLE_PARALLEL_EXECUTION:-true}
    working_dir: /workspace
    # ネットワークアクセスを許可（API呼び出し用）
    network_mode: bridge
    # 長時間実行を許可
    restart: unless-stopped
    # インタラクティブモードで実行（初回認証用）
    stdin_open: true
    tty: true

volumes:
  cursor-config:
    # Cursor CLIの認証情報を永続化（/root/.cursor）
  cursor-config-config:
    # Cursor CLIの認証情報を永続化（/root/.config/cursor）
